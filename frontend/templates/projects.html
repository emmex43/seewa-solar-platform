<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEEWA - Projects Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #2E8B57 !important;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .badge {
            font-size: 0.75em;
        }
        .btn-primary {
            background-color: #2E8B57;
            border-color: #2E8B57;
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="/">ðŸŒž SEEWA</a>
        <div class="navbar-nav">
            <a class="nav-link" href="/">Home</a>
            <a class="nav-link" href="/calculator">Solar Calculator</a>
            {% if current_user.is_authenticated %}
                <a class="nav-link" href="/projects">Projects</a>
                <a class="nav-link" href="/appliances">Appliances</a>
                <a class="nav-link" href="/analytics">Analytics</a>
                <a class="nav-link" href="/logout">Logout ({{ current_user.username }})</a>
            {% else %}
                <a class="nav-link" href="/login">Login</a>
                <a class="nav-link" href="/register">Register</a>
            {% endif %}
        </div>
    </div>
</nav>
    <div class="container mt-4">
        <h1 class="mb-4">SEEWA Renewable Projects - Nigeria</h1>
        
        <!-- Add Project Form -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Add New Project</h5>
            </div>
            <div class="card-body">
                <form id="addProjectForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="projectName" placeholder="Project Name" required>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" id="projectLocation" placeholder="Location (Nigeria)" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="projectCapacity" placeholder="Capacity (kW)" step="0.01" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="projectCost" placeholder="Cost (USD)" step="0.01" required>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="projectStatus" required>
                                <option value="planned">Planned</option>
                                <option value="ongoing" selected>Ongoing</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary w-100">Add</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Projects Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Renewable Energy Projects in Nigeria</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="projectsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Project Name</th>
                                <th>Location</th>
                                <th>Capacity (kW)</th>
                                <th>Cost (USD)</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <!-- Projects will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class ProjectsManager {
            constructor() {
                this.apiBase = '/api';
                this.init();
            }

            init() {
                this.loadProjects();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('addProjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addProject();
                });
            }

            async loadProjects() {
                try {
                    const response = await fetch(`${this.apiBase}/projects`);
                    const data = await response.json();
                    this.renderProjects(data);
                } catch (error) {
                    console.error('Error loading projects:', error);
                    this.showAlert('Error loading projects', 'danger');
                }
            }

            renderProjects(projects) {
                const tbody = document.getElementById('projectsTableBody');
                tbody.innerHTML = '';

                projects.forEach(project => {
                    const row = document.createElement('tr');
                    
                    let statusClass = 'bg-secondary';
                    if (project.status === 'ongoing') statusClass = 'bg-warning text-dark';
                    if (project.status === 'completed') statusClass = 'bg-success';

                    row.innerHTML = `
                        <td>${project.id}</td>
                        <td>${this.escapeHtml(project.project_name)}</td>
                        <td>${this.escapeHtml(project.location)}</td>
                        <td>${project.capacity_kw.toLocaleString()}</td>
                        <td>$${project.cost_usd.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${project.status}</span></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="projectsManager.deleteProject(${project.id})">
                                Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            async addProject() {
                const formData = {
                    project_name: document.getElementById('projectName').value,
                    location: document.getElementById('projectLocation').value,
                    capacity_kw: parseFloat(document.getElementById('projectCapacity').value),
                    cost_usd: parseFloat(document.getElementById('projectCost').value),
                    status: document.getElementById('projectStatus').value
                };

                try {
                    const response = await fetch(`${this.apiBase}/projects`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.id) {
                        document.getElementById('addProjectForm').reset();
                        this.loadProjects();
                        this.showAlert('Project added successfully!', 'success');
                    } else {
                        this.showAlert('Error adding project', 'danger');
                    }
                } catch (error) {
                    console.error('Error adding project:', error);
                    this.showAlert('Error adding project', 'danger');
                }
            }

            async deleteProject(projectId) {
                if (!confirm('Are you sure you want to delete this project?')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBase}/projects/${projectId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.message) {
                        this.loadProjects();
                        this.showAlert('Project deleted successfully!', 'success');
                    } else {
                        this.showAlert('Error deleting project', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting project:', error);
                    this.showAlert('Error deleting project', 'danger');
                }
            }

            showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.card'));
                
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }

        const projectsManager = new ProjectsManager();

    </script>
</body>
</html>